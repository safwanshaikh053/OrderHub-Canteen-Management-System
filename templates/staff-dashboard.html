<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>OrderHub Campus | Staff Dashboard</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">

<style>
:root{
  --primary:#4f46e5;
  --secondary:#06b6d4;
  --bg:#f5f7ff;
  --card-bg:rgba(255,255,255,0.95);
}

body{
  background:var(--bg);
  font-family:"Inter",sans-serif;
}

/* ================= NAVBAR ================= */
.navbar{
  background:linear-gradient(135deg,var(--primary),var(--secondary));
  box-shadow:0 10px 25px rgba(0,0,0,0.15);
}

.navbar-brand{
  font-weight:800;
}

.navbar-brand-center{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  font-weight:700;
  font-size:1.1rem;
}

/* ================= STATS ================= */
.stat-card{
  background:var(--card-bg);
  padding:22px;
  border-radius:18px;
  box-shadow:0 20px 40px rgba(0,0,0,0.12);
  transition:0.3s;
}

.stat-card:hover{
  transform:translateY(-6px);
}

.stat-card h6{
  font-weight:600;
  color:#666;
}

.stat-card h3{
  font-weight:800;
  margin-top:6px;
  color:var(--primary);
}

.stat-icon{
  font-size:28px;
  color:var(--secondary);
}

/* ================= CARDS ================= */
.card{
  border-radius:18px;
  border:none;
  box-shadow:0 20px 40px rgba(0,0,0,0.1);
}

.card-header{
  border-radius:18px 18px 0 0 !important;
  font-weight:700;
}

/* ================= TABLE ================= */
.table th{
  font-weight:600;
  border:none;
}

.table td{
  vertical-align:middle;
}

.table-hover tbody tr:hover{
  background:#f1f3ff;
}

/* ================= BUTTONS ================= */
.btn{
  border-radius:999px;
  font-weight:600;
}

.btn-danger,
.btn-success,
.btn-warning,
.btn-primary{
  border:none;
}

.btn-primary{
  background:linear-gradient(135deg,var(--primary),var(--secondary));
}

.btn-primary:hover{
  transform:translateY(-2px);
  box-shadow:0 10px 25px rgba(79,70,229,0.4);
}

/* ================= LIST ================= */
.list-group-item{
  border-radius:12px;
  margin-bottom:6px;
}

/* ================= INPUT ================= */
.form-control{
  border-radius:12px;
}
</style>
</head>

<body>

<!-- NAVBAR -->
<nav class="navbar navbar-dark px-4 position-relative">
  <span class="navbar-brand">üçΩ OrderHub</span>
<!--   <span class="navbar-brand-center text-white">OrderHub Campus</span> -->
  <span class="text-white">
    <i class="fas fa-user-circle"></i>
    Hi, <b id="staffName"></b>
    <a href="/login" class="btn btn-sm btn-outline-light ms-3">Logout</a>
  </span>
</nav>

<div class="container-fluid mt-4">

  <!-- STATS -->
  <div class="row g-4 mb-4">

    <div class="col-md-3">
      <div class="stat-card">
        <h6>Total Orders</h6>
        <h3 id="totalOrders">0</h3>
      </div>
    </div>

    <div class="col-md-3">
      <div class="stat-card">
        <h6>Pending Orders</h6>
        <h3 id="pendingOrders">0</h3>
      </div>
    </div>

    <div class="col-md-3">
      <div class="stat-card">
        <h6>Low Stock Items</h6>
        <h3 id="lowStock">0</h3>
      </div>
    </div>

    <div class="col-md-3">
      <div class="stat-card">
        <h6>Available Drinks</h6>
        <h3 id="drinkCount">0</h3>
      </div>
    </div>

  </div>

  <div class="row">

    <!-- LEFT -->
    <div class="col-md-8">

      <!-- ORDERS -->
      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          Customer Orders
        </div>
        <div class="card-body">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Item Names</th>
<!--                 <th>Instruction</th> -->
<!--                 <th>Status</th> -->
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="ordersTable">
              <tr>
                <td colspan="6" class="text-muted text-center">
                  Currently No Orders ......
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- INGREDIENT INVENTORY -->
      <div class="card mb-4">
        <div class="card-header bg-success text-white">
          Ingredient Inventory
        </div>
        <div class="card-body">
          <table class="table">
            <thead>
              <tr>
                <th>Item</th>
                <th>Min</th>
                <th>Stock</th>
              </tr>
            </thead>
            <tbody id="ingredientTable">
              <tr>
                <td colspan="4" class="text-muted text-center">
                  Coming soon
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- DRINKS -->
      <div class="card mb-4">
        <div class="card-header bg-warning">
          Drinks Inventory
        </div>
        <div class="card-body">
          <table class="table">
            <thead>
              <tr>
                <th>Drink</th>
                <th>Min</th>
                <th>Stock</th>
              </tr>
            </thead>
            <tbody id="drinkTable">
              <tr>
                <td colspan="4" class="text-muted text-center">
                  Coming soon
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>

    <!-- RIGHT -->
    <div class="col-md-4">

      <!-- RESTOCK -->
      <div class="card mb-4">
        <div class="card-header bg-danger text-white">
          Restock Requests
        </div>
        <div class="card-body">

          <ul class="list-group mb-3" id="restockList">
            <li class="list-group-item text-muted">
              Requests appear in Admin Dashboard
            </li>
          </ul>

          <input type="text" class="form-control mb-2" id="restockItem" placeholder="Item name">
          <input type="number" class="form-control mb-2" id="restockQty" placeholder="Quantity">
          <input type="text" class="form-control mb-3" id="restockUrgency" placeholder="Urgency (Low / Medium / High)">

          <button class="btn btn-danger w-100" onclick="addRestock()">
            Submit Request
          </button>

        </div>
      </div>

    </div>
  </div>
</div>

<!-- =================== SCRIPT (UNCHANGED) =================== -->
<script>
let lowStockCount = 0;
/* INIT STAFF */
const staffId = Number(localStorage.getItem("staffId"));
const staffName = localStorage.getItem("staffName") || "Staff";

document.getElementById("staffName").innerText = staffName;

/* ================= RESTOCK SUBMIT ================= */
async function addRestock() {

  const itemName = document.getElementById("restockItem").value.trim();
  const requestedQuantity = Number(document.getElementById("restockQty").value);
  const urgency = document.getElementById("restockUrgency").value.trim();

  if (!staffId) {
    alert("‚ùå Staff not logged in");
    return;
  }

  if (!itemName || requestedQuantity <= 0) {
    alert("‚ùå Please enter valid item and quantity");
    return;
  }

  const payload = {
    staffId: staffId,
    itemName: itemName,
    requestedQuantity: requestedQuantity,
    note: urgency
  };

  console.log("üì¶ Sending:", payload);

  try {
    const res = await fetch("/api/staff/restock-requests", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      const text = await res.text();
      console.error("‚ùå Backend error:", text);
      alert("‚ùå Failed to submit restock request");
      return;
    }

    alert("‚úÖ Restock request submitted");

    document.getElementById("restockItem").value = "";
    document.getElementById("restockQty").value = "";
    document.getElementById("restockUrgency").value = "";

  } catch (err) {
    console.error(err);
    alert("‚ùå Failed to submit restock request");
  }
}

/* ================= STAFF ORDERS ================= */
function loadStaffOrders() {
    fetch("http://localhost:8081/api/staff/orders")
        .then(res => res.json())
        .then(data => {
            const tbody = document.getElementById("ordersTable");
            tbody.innerHTML = "";

            if (!data || data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-muted">
                            Currently No Orders ......
                        </td>
                    </tr>`;
                return;
            }

            data.forEach(order => {
                tbody.innerHTML += `
                    <tr>
                        <td>${order.orderId}</td>
                        <td>
                            ${order.customerName}<br>
                            <small class="text-muted">ID: ${order.customerId}</small>
                        </td>
                        <td>
                            <ul class="mb-0">
                                ${(order.items || []).map(i => `<li>${i}</li>`).join("")}
                            </ul>
                        </td>
                        <td>
                            <button class="btn btn-success btn-sm"
                                onclick="markReady(${order.orderId})">
                                READY
                            </button>
                        </td>
                    </tr>`;
            });
        })
        .catch(err => console.error("Failed to load staff orders", err));
}

function markReady(orderId) {
    fetch(`http://localhost:8081/api/staff/orders/${orderId}/ready`, {
        method: "PATCH"
    })
    .then(() => {
        alert("Order marked READY");
        loadStaffOrders();
    });
}

function loadDrinksInventory() {
    fetch("http://localhost:8081/api/staff/drinks")
        .then(res => res.json())
        .then(data => {

            const tbody = document.getElementById("drinkTable");
            tbody.innerHTML = "";

            if (!data || data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-muted">
                            No drinks available
                        </td>
                    </tr>`;
                return;
            }

            data.forEach(drink => {

                const lowStock =
                    drink.currentStock !== null &&
                    drink.minStockLevel !== null &&
                    drink.currentStock <= drink.minStockLevel;
                
                if (lowStock) {
                    lowStockCount++;
                }

                tbody.innerHTML += `
                    <tr class="${lowStock ? 'table-danger' : ''}">
                        <td>${drink.drinkName}</td>
                        <td>${drink.minStockLevel ?? '-'} </td>
                        <td>${drink.currentStock ?? '-'}</td>
                    </tr>`;
            });
        })
        .catch(err => {
            console.error("Failed to load drinks inventory:", err);
        });
}

function loadStaffStats() {
    fetch("http://localhost:8081/api/admin/dashboard/stats")
        .then(res => res.json())
        .then(data => {

            // Total Orders
            document.getElementById("totalOrders").innerText =
                data.totalOrders ?? 0;

            // Pending Orders
            document.getElementById("pendingOrders").innerText =
                data.pendingOrders ?? 0;

        })
        .catch(err => {
            console.error("Failed to load staff stats:", err);
        });
}

function loadLowStockDrinks() {
    fetch("http://localhost:8081/api/staff/drinks")
        .then(res => res.json())
        .then(drinks => {

            const drinkLowStock = drinks.filter(d =>
                d.currentStock != null &&
                d.minStockLevel != null &&
                d.currentStock <= d.minStockLevel
            ).length;

            // update counts
            document.getElementById("drinkCount").innerText = drinks.length;

            // add to existing ingredient low-stock count
            document.getElementById("lowStock").innerText =
                lowStockCount + drinkLowStock;
        });
}


function loadIngredientInventory() {
	
    fetch("http://localhost:8081/api/staff/ingredients")
        .then(res => res.json())
        .then(data => {

            const tbody = document.getElementById("ingredientTable");
            tbody.innerHTML = "";

            if (!data || data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-muted">
                            No ingredients found
                        </td>
                    </tr>`;
                return;
            }

            data.forEach(item => {
                const lowStock = item.currentStock <= item.minStock;

                tbody.innerHTML += `
                    <tr class="${lowStock ? 'table-danger' : ''}">
                        <td>${item.ingredientName}</td>
                        <td>${item.minStock} ${item.unit || ''}</td>
                        <td>${item.currentStock} ${item.unit || ''}</td>
                    </tr>`;
            });
        })
        .catch(err => {
            console.error("Failed to load ingredient inventory:", err);
        });
}

loadStaffOrders();
loadDrinksInventory();
loadStaffStats();
loadLowStockDrinks();
loadIngredientInventory();

</script>

</body>
</html>
