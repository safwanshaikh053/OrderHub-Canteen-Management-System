<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orders - OrderHub Campus</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <link rel="stylesheet" th:href="@{/css/staff-orders.css}">
</head>
<body>
    <nav class="navbar">
        <div class="container-fluid d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-3">
                <img th:src="@{/images/logo.png}" alt="OrderHub Logo" class="nav-logo" th:onclick="|window.location.href='@{/staff/dashboard}'|">
                <span class="brand-name">OrderHub Campus</span>
            </div>
            <input type="text" class="search-input rounded-pill px-4" placeholder="Search orders..." id="searchInput">
            <div class="nav-actions d-flex align-items-center gap-3">
                <button class="btn btn-primary rounded-pill">Hi, Staff</button>
                <button class="menu-btn btn btn-outline-secondary" onclick="toggleMenu()">⋮</button>
            </div>
        </div>
    </nav>

    <div class="side-menu" id="sideMenu">
        <div class="menu-header">Staff Menu</div>
        <a th:href="@{/staff/profile}"><i class="fas fa-user"></i><span>My Profile</span></a>
        <a th:href="@{/staff/dashboard}"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a>
        <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a>
    </div>

    <div class="container my-5">
        <div class="page-header">
            <h2><i class="fas fa-receipt"></i> Customer Orders</h2>
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="filterOrders('all')">All Orders</button>
                <button class="filter-btn" onclick="filterOrders('pending')">Pending</button>
                <button class="filter-btn" onclick="filterOrders('ready')">Ready</button>
            </div>
        </div>
        <div class="orders-grid" id="ordersGrid"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
        /* --- Common Logic --- */
        function checkStaffAuth() {
            const staffData = localStorage.getItem('staffData');
            if (!staffData) { window.location.href = '/login'; return null; }
            return JSON.parse(staffData);
        }
        function updateNavbar() {
            const staffData = checkStaffAuth();
            if (staffData) {
                const loginBtn = document.querySelector('.btn-primary');
                if (loginBtn) { loginBtn.textContent = `Hi, ${staffData.name}`; }
            }
        }
        function toggleMenu() { document.getElementById('sideMenu').classList.toggle('active'); }
        function logout() { if (confirm('Logout?')) { localStorage.removeItem('staffData'); window.location.href = '/login'; } }

        /* --- Orders Logic --- */
        let orders = [];
        let currentFilter = 'all';

        function getSampleOrders() {
            return [
                { id: 'ORD001', customer: 'Rahul Sharma', items: 'Masala Dosa x2', amount: 190, status: 'pending', time: '10:30 AM', paid: true },
                { id: 'ORD002', customer: 'Priya Reddy', items: 'Idli Sambar x1', amount: 120, status: 'pending', time: '10:35 AM', paid: true }
            ];
        }

        function loadOrders() {
            const stored = localStorage.getItem('customerOrders');
            orders = stored ? JSON.parse(stored) : getSampleOrders();
            displayOrders();
        }

        function displayOrders(searchTerm = '') {
            const grid = document.getElementById('ordersGrid');
            grid.innerHTML = '';
            let filtered = orders.filter(o => (currentFilter === 'all' || o.status === currentFilter));
            if (searchTerm) {
                filtered = filtered.filter(o => o.customer.toLowerCase().includes(searchTerm) || o.id.toLowerCase().includes(searchTerm));
            }
            filtered.forEach(order => {
                grid.innerHTML += `
                    <div class="order-card">
                        <div class="order-header"><strong>${order.id}</strong> <span>${order.time}</span></div>
                        <div class="mb-2"><i class="fas fa-user"></i> ${order.customer}</div>
                        <div class="small mb-3">${order.items}</div>
                        <div class="d-flex justify-content-between align-items-center">
                            <strong>₹${order.amount}</strong>
                            <button class="btn btn-sm btn-success" onclick="markAsReady('${order.id}')" ${order.status === 'ready' ? 'disabled' : ''}>
                                ${order.status === 'ready' ? 'Ready' : 'Mark Ready'}
                            </button>
                        </div>
                    </div>`;
            });
        }

        function markAsReady(orderId) {
            const idx = orders.findIndex(o => o.id === orderId);
            if (idx !== -1) {
                orders[idx].status = 'ready';
                localStorage.setItem('customerOrders', JSON.stringify(orders));
                displayOrders();
            }
        }

        function filterOrders(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            displayOrders();
        }

        document.addEventListener('DOMContentLoaded', () => {
            updateNavbar();
            loadOrders();
            document.getElementById('searchInput').addEventListener('input', (e) => displayOrders(e.target.value.toLowerCase()));
        });
    </script>
</body>
</html>